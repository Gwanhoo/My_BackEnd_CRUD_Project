<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì±„íŒ…ë°©</title>
  <link rel="stylesheet" href="/output.css?v=<%= Date.now() %>">
</head>
<body class="bg-gray-50 text-gray-800">
  <%- include('nav.ejs') %>

  <main class="max-w-3xl mx-auto px-4 py-10">
    <h1 class="text-2xl font-semibold mb-pr-16 flex items-center gap-pr-8">
      ğŸ’¬ ì±„íŒ…ë°©
    </h1>

    <!-- ì±„íŒ… ë©”ì‹œì§€ ë°•ìŠ¤ -->
    <div id="chatBox"
         class="bg-white border rounded-pr-12 h-[400px] overflow-y-auto p-pr-12 space-y-pr-8 mb-pr-12 shadow-sm">
      <% if (messages && messages.length > 0) { %>
        <% messages.forEach(m => { %>
          <div class="flex <%= String(m.senderId) === String(user._id) ? 'justify-end' : 'justify-start' %>">
            <div
              class="<%= String(m.senderId) === String(user._id)
                ? 'bg-blue-600 text-white'
                : 'bg-gray-200 text-gray-800' %>
                     px-pr-10 py-pr-6 rounded-pr-10 max-w-[70%] break-words">
              <%= m.message %>
            </div>
          </div>
        <% }) %>
      <% } %>
    </div>

    <!-- ë©”ì‹œì§€ ì…ë ¥ -->
    <form id="chatForm" class="flex gap-pr-10">
      <input
        id="msgInput"
        type="text"
        placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
        class="flex-1 border-pr-1 border-gray-300 rounded-pr-8 px-pr-10 h-pr-40 focus:outline-none focus:border-blue-500"
        autocomplete="off"
      />
      <button
        type="submit"
        class="px-pr-16 h-pr-40 bg-blue-600 text-white rounded-pr-8 hover:bg-blue-700 transition">
        ë³´ë‚´ê¸°
      </button>
    </form>
  </main>

  <!-- socket.io í´ë¼ì´ì–¸íŠ¸ -->
<!-- socket.io í´ë¼ì´ì–¸íŠ¸ -->
<script src="/socket.io/socket.io.js"></script>
<script>
  // ì´ë¯¸ ë§Œë“¤ì–´ì§„ ì†Œì¼“ì´ ìˆìœ¼ë©´ ì¬ì‚¬ìš©, ì—†ìœ¼ë©´ ìƒˆë¡œ ë§Œë“¤ê¸°
  const socket = window.socket || io();
  window.socket = socket; // ì „ì—­ì— ë³´ê´€í•´ì„œ ì¤‘ë³µ ìƒì„± ë°©ì§€

  const roomId = "<%= room._id %>";
  const myId = "<%= user._id %>";

  const chatBox = document.getElementById('chatBox');
  const chatForm = document.getElementById('chatForm');
  const msgInput = document.getElementById('msgInput');

  // ì²˜ìŒ ë“¤ì–´ì™”ì„ ë•Œë„ ë§¨ ì•„ë˜ë¡œ
  chatBox.scrollTop = chatBox.scrollHeight;

  // ì†Œì¼“ì´ ì´ë¯¸ ì—°ê²°ë¼ ìˆìœ¼ë©´ ë°”ë¡œ ë°© ì…ì¥
  if (socket.connected) {
    socket.emit('join-room', roomId);
  } else {
    // ì•„ì§ì´ë©´ ì—°ê²° í›„ì— í•œ ë²ˆë§Œ ë°© ì…ì¥
    socket.once('connect', () => {
      socket.emit('join-room', roomId);
    });
  }

  // í˜¹ì‹œ ì´ì „ í˜ì´ì§€ì—ì„œ ë‹¬ë ¤ìˆë˜ ë¦¬ìŠ¤ë„ˆê°€ ìˆìœ¼ë©´ ì œê±°
  socket.off('chat-message');

  // ì„œë²„ì—ì„œ ë°›ì€ ë©”ì‹œì§€ ê·¸ë¦¬ê¸° (ì´ê±´ ë‚´ ë©”ì‹œì§€ ë§ê³ , ë‹¤ë¥¸ ì‚¬ëŒ ë©”ì‹œì§€ê°€ ë“¤ì–´ì˜´)
  socket.on('chat-message', (data) => {
    addMessage(data);
  });

  // í¼ ì „ì†¡í•˜ë©´ ë‚´ê°€ ë¨¼ì € í™”ë©´ì— ê·¸ë¦¬ê³  ì„œë²„ë¡œ ë³´ëƒ„
  chatForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const msg = msgInput.value.trim();
    if (!msg) return;

    // 1) ë‚´ í™”ë©´ì— ë°”ë¡œ ê·¸ë¦¬ê¸°
    addMessage({
      senderId: myId,
      message: msg
    });

    // 2) ì„œë²„ë¡œ ë³´ë‚´ê¸°
    socket.emit('chat-message', {
      roomId,
      senderId: myId,
      message: msg
    });

    msgInput.value = '';
    msgInput.focus();
  });

  // ê³µìš© ë©”ì‹œì§€ ë Œë” í•¨ìˆ˜
  function addMessage(data) {
    const wrap = document.createElement('div');
    const isMe = (data.senderId === myId);

    wrap.className = 'flex ' + (isMe ? 'justify-end' : 'justify-start');

    const bubble = document.createElement('div');
    bubble.className = (isMe
      ? 'bg-blue-600 text-white'
      : 'bg-gray-200 text-gray-800'
    ) + ' px-pr-10 py-pr-6 rounded-pr-10 max-w-[70%] break-words';

    bubble.textContent = data.message;

    wrap.appendChild(bubble);
    chatBox.appendChild(wrap);

    // í•­ìƒ ë§¨ ì•„ë˜ë¡œ
    chatBox.scrollTop = chatBox.scrollHeight;
  }
</script>



</body>
</html>
